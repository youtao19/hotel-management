# 📋 交接班需求文档

## 🗄️ 数据库表结构

### 使用新的建表语句

```sql
CREATE TABLE handover (
    id SERIAL PRIMARY KEY,                -- 主键，自增
    date DATE NOT NULL,                   -- 交接日期
    handover_person VARCHAR(50) NOT NULL, -- 交班人
    takeover_person VARCHAR(50) NOT NULL, -- 接班人
    vip_card INT DEFAULT 0,               -- VIP 卡数量

    payment_type SMALLINT NOT NULL,       -- 1=现金, 2=微信, 3=微邮付, 4=其他
    reserve_cash NUMERIC(10,2) DEFAULT 0, -- 备用金
    room_income NUMERIC(10,2) DEFAULT 0,  -- 客房收入
    rest_income NUMERIC(10,2) DEFAULT 0,  -- 休息房收入
    rent_income NUMERIC(10,2) DEFAULT 0,  -- 租车收入
    total_income NUMERIC(10,2) DEFAULT 0, -- 合计
    room_refund NUMERIC(10,2) DEFAULT 0,  -- 客房退押
    rest_refund NUMERIC(10,2) DEFAULT 0,  -- 休息房退押
    retained NUMERIC(10,2) DEFAULT 0,     -- 留存款
    handover NUMERIC(10,2) DEFAULT 0,     -- 交接款

    task_list TEXT[] DEFAULT '{}',        -- 备忘录数组（每条是一项）
    remarks TEXT                          -- 备注信息
);
```

### 字段说明
- **基本信息**：日期、交班人、接班人、VIP卡数量
- **支付类型**：1=现金，2=微信，3=微邮付，4=其他  
- **金额字段**：备用金、客房收入、休息房收入、租车收入、合计、客房退押、休息房退押、留存款、交接款
- **其他**：备忘录数组、备注信息

## 🔄 交接流程

### 操作流程
1. **查看限制**：只能查看已有交接班记录的日期，无记录日期不可访问
2. **开始交接**：点击"开始交接班"按钮触发以下操作：
   - 保存昨日交接数据到数据库
   - 创建新的交接记录
   - 使今天日期变为可访问状态
3. **工作周期**：接班人早上接班 → 工作到第二天早上 → 交班给下一个接班人

### 交接逻辑
- 未保存到数据库的交接班数据，根据前端选择的交接班日期，从账单表中提取数据插入到交接班表
- 后端已提供账单表数据提取接口，前端调用接口获取数据展示

## 📊 数据来源与计算逻辑

### 收入数据来源
- **客房收入**：账单表中 `stay_date=交接班日期` 且 `change_type="客房"` 的 `room_fee` 总和
- **休息房收入**：账单表中 `stay_date=交接班日期` 且 `change_type="休息房"` 的 `room_fee` 总和

### 计算公式
```
合计 = 备用金 + 客房收入 + 休息房收入 + 租车收入
交接款 = 合计 - 客房退押 - 休息房退押
```

### 备用金来源规则
- **现金类型**：来自前一天交接班的留存款
- **非现金类型**：来自前一天交接班的交接款

## 📅 业务规则

### 核心约束
- **唯一性**：一天只能有一条交接班记录
- **日期限制**：查询日期只显示有交接班记录的日期
- **数据关联**：与现有账单系统保持数据一致性

### 支付方式分类
1. 现金
2. 微信 
3. 微邮付
4. 其他

## 🎯 实施要点

- 使用新的 `handover` 表替换原有交接班相关表结构
- 保持与现有账单系统的数据关联
- 支持不同支付方式的分类管理
- 实现完整的交接班业务流程控制