# 办理入住逻辑变更需求 (V4 - Final)

## 1. 目标
优化现有办理入住流程。当用户点击“办理入住”时，系统需要根据订单的入住天数，自动为每一天生成独立的“房费”账单，并将这些操作作为一个整体事务来处理，以确保数据一致性。

## 2. 数据表分析
- **`orders` 表**: 包含订单的核心信息。我们将主要使用 `order_id`, `guest_name`, `room_number`, `check_in_date`, `check_out_date`, `status`, `stay_type` 和 `total_price` 字段。
- **`bills` 表**: 用于记录所有费用条目。分析发现此表当前无数据，我们将引入一个新的 `pay_way` 值来支持本功能。

**核心方案**:
为了将一笔“待支付”的费用录入到 `bills` 表中，我们将采用以下约定：
- `pay_way` 字段存入一个特殊值 从订单中的 `payment_method` 字段获取。
- `remarks` 字段存入 **`'订单账单'`**，以作区分。
- `room_fee` 字段存入订单的 **`total_price`**，并根据入住天数拆分为每日房费，使用总金额的平均值。

## 3. 后端实现方案
后端需要提供一个新的API端点来处理该请求 (`/api/orders/:orderId/check-in`)，具体逻辑如下：

1.  **开启数据库事务**: 所有数据库操作（插入账单、更新订单）都必须包含在一个事务中。
2.  **获取订单信息**: 根据API接收到的 `order_id`，查询订单信息，特别是 `check_in_date`, `check_out_date`, 和 `total_price`。
3.  **计算平均每日房价**: 
    -   计算总入住夜数 (nights = `check_out_date` - `check_in_date`)。
    -   计算平均每日房价 (`average_daily_rate = total_price / nights`)。注意处理除以零的边缘情况。
4.  **生成每日账单**:
    -   以 `check_in_date` 为起点，循环创建每一天的账单记录，直到 `check_out_date` 的前一天。
    -   对于每一天的记录，构造一个符合 `bills` 表结构的账单对象并插入数据库：
        -   `order_id`: 从订单信息中获取。
        -   `room_number`: 从订单信息中获取。
        -   `guest_name`: 从订单信息中获取。
        -   `room_fee`: 使用上一步计算出的 **`average_daily_rate`**。
        -   `pay_way`: 从订单信息中获取。
        -   `create_time`: 当前服务器时间。
        -   `remarks`: **`'订单账单'`**。
        -   `stay_type`: 从订单信息中获取。
        -   `stay_date`: 循环中的当前日期。
        -   `deposit`, `change_price`, `change_type`: 使用其默认值 (`0` 或 `null`)。
5.  **更新订单状态**:
    -   在所有账单成功插入后，将 `orders` 表中对应订单的 `status` 字段更新为 **`'checked-in'`**。
6.  **事务控制**:
    -   **成功**: 如果所有数据库操作均成功，则提交事务。
    -   **失败**: 如果任何一步操作失败，则回滚整个事务，并向前端返回错误信息。

## 4. 前端交互
1.  用户在“查看订单”页面点击“办理入住”按钮后，前端调用新的后端API。
2.  API调用成功后，显示“办理入住成功”的提示，并刷新订单列表以更新订单状态。
3.  API调用失败后，显示具体的错误提示信息。