# 修改 `bills` 表以包含房费和押金

## 概述

此文档旨在指导将订单的房费和押金信息整合到 `bills` 表中的过程。这将涉及数据库模式的修改、后端 API 的调整以及潜在的前端逻辑更新。

## 详细修改清单

### 阶段一：数据库模式修改

1.  **分析现有 `bills` 表和 `orders` 表结构：**
    *   确认 `bills` 表当前包含哪些字段。
    *   确认 `orders` 表中房费和押金字段的名称和数据类型。
    *   **操作：** 检查 `backend/database/postgreDB/migrations/` 目录下的迁移文件，以及 `db_schema_export.sql` 或 `scripts/structure.sql` 文件，以获取最新的表结构信息。

2.  **创建新的数据库迁移文件：**
    *   在 `backend/database/postgreDB/migrations/` 目录下创建一个新的 SQL 迁移文件（例如：`YYYYMMDD_add_room_fee_deposit_to_bills.sql`）。
    *   在该文件中添加 `ALTER TABLE bills ADD COLUMN ...` 语句，为房费和押金添加新字段。
        *   **建议字段：**
            *   `room_fee DECIMAL(10, 2) DEFAULT 0.00;` (房费)
            *   `deposit DECIMAL(10, 2) DEFAULT 0.00;` (押金)
        *   **考虑：** 是否需要记录这些金额的来源（例如，关联到 `orders` 表的 `order_id`，如果 `bills` 表尚未直接关联订单）。

3.  **运行数据库迁移：**
    *   **操作：** 执行 `npm run db:migrate` 命令来应用新的数据库模式更改。
    *   **注意：** 在生产环境执行前，务必在开发或测试环境中充分测试。

### 阶段二：后端 API 修改

1.  **修改 `billModule.js` 和 `orderModule.js`：**
    *   **`billModule.js`：**
        *   在创建账单或更新账单的逻辑中，确保从订单数据中获取房费和押金，并将其保存到 `bills` 表的新字段中。
        *   检查所有涉及 `bills` 表查询的函数，确保它们能够正确处理新的 `room_fee` 和 `deposit` 字段。
    *   **`orderModule.js`：**
        *   在订单创建、更新或取消的逻辑中，确保与 `bills` 表的同步操作能够正确传递房费和押金信息。
        *   如果订单修改会影响房费或押金，确保这些更改能够正确地反映到关联的账单中。

2.  **修改相关路由文件：**
    *   **`backend/routes/billRoute.js`：**
        *   检查所有与账单相关的 API 接口（例如：创建账单、获取账单详情、更新账单），确保它们能够接收、处理和返回房费和押金数据。
    *   **`backend/routes/orderRoute.js`：**
        *   检查所有与订单相关的 API 接口，确保在订单操作时，房费和押金能够正确地传递给账单处理逻辑。

3.  **更新数据验证和业务逻辑：**
    *   确保所有涉及房费和押金的计算、汇总和展示逻辑都已更新，以使用 `bills` 表中的新字段。
    *   考虑任何与房费和押金相关的业务规则（例如：退款逻辑、费用调整），并相应地更新后端逻辑。

4.  **更新测试用例：**
    *   **操作：** 修改或添加 `tests/` 目录下的相关测试文件（例如：`orderCreate.test.js`, `refundDeposit.test.js`, `revenueRoute.test.js`），以覆盖新的房费和押金字段的逻辑。
    *   确保测试能够验证房费和押金的正确存储、检索和计算。

### 阶段三：前端修改（如果需要）

1.  **更新 Pinia Store：**
    *   **`src/stores/billStore.js` 和 `src/stores/orderStore.js`：**
        *   更新相关 state 和 action，以包含和处理房费和押金数据。
        *   确保从后端获取账单或订单数据时，能够正确地解析和存储这些新字段。

2.  **更新前端组件和页面：**
    *   **`src/components/BillAdjustmentDialog.vue` 或其他账单相关组件：**
        *   如果前端需要显示或允许编辑房费和押金，更新这些组件的模板和逻辑。
    *   **`src/pages/ViewOrders.vue` 或 `src/pages/CreateOrder.vue`：**
        *   如果订单页面需要显示或处理房费和押金，更新这些页面的模板和逻辑。

3.  **更新 API 调用：**
    *   **`src/api/index.js`：**
        *   如果后端 API 接口的请求或响应结构因房费和押金的添加而改变，更新前端的 API 调用方法。

### 阶段四：验证与部署

1.  **本地全面测试：**
    *   在本地开发环境中，执行所有功能测试，确保房费和押金的存储、显示、计算和相关业务逻辑都正确无误。
    *   **操作：** 运行 `npm test` 确保所有单元和集成测试通过。
    *   **操作：** 启动前端和后端 (`npm start`)，手动测试所有受影响的页面和功能。

2.  **代码审查：**
    *   在提交代码前，进行彻底的代码审查，确保所有更改都符合项目约定和最佳实践。

3.  **部署：**
    *   在测试环境部署，进行进一步的集成测试和用户验收测试。
    *   确认无误后，再部署到生产环境。

## 注意事项

*   **数据迁移：** 如果现有订单数据需要将房费和押金回填到 `bills` 表中，你可能需要编写一次性脚本来执行数据迁移。
*   **历史数据：** 考虑如何处理修改前已存在的账单数据。如果它们没有房费和押金字段，在查询时需要进行兼容性处理。
*   **错误处理：** 在后端和前端都添加健壮的错误处理机制，以应对数据不一致或 API 调用失败的情况。
*   **性能：** 评估数据库模式更改和后端逻辑调整对系统性能的影响，并在必要时进行优化。
*   **文档更新：** 确保所有相关的开发文档（例如 API 文档、数据库设计文档）都已更新，以反映这些更改。
