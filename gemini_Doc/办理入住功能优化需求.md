# 办理入住功能优化需求

## 1. 需求背景

当前酒店管理系统中，“办理入住”功能在更新订单状态后才弹出账单确认界面。这可能导致以下问题：
*   用户在确认账单前，订单状态已发生变更，不符合业务流程的严谨性。
*   如果在账单确认过程中，用户修改了房费或押金，这些修改未能及时且自动地同步回订单主记录，可能导致数据不一致。

## 2. 优化目标

本优化旨在提升“办理入住”功能的业务流程合理性和数据一致性，具体目标如下：
1.  **账单确认前置**: 确保账单确认是订单状态更新为“已入住”的前置步骤。
2.  **房费/押金同步**: 确保用户在账单确认界面对房费和押金的任何修改，都能自动同步更新到订单记录中。

## 3. 优化方案

### 3.1 流程调整

**优化前流程 (简化)**:
1.  用户点击“办理入住”。
2.  订单状态更新为“已入住”。
3.  弹出账单创建对话框。
4.  用户确认账单。

**优化后流程 (简化)**:
1.  用户点击“办理入住”。
2.  **弹出账单创建对话框**。
3.  用户在对话框中确认账单（可能修改房费/押金）。
4.  **比较账单数据与原始订单数据**：如果房费或押金有修改。
5.  **更新订单表中的房费/押金**（如果存在修改）。
6.  **更新订单状态为“已入住”**。
7.  刷新相关界面。

### 3.2 前端实现调整 (`src/pages/ViewOrders.vue`)

#### `performCheckIn` 函数调整
*   **职责变更**: 该函数将不再直接负责更新订单状态或刷新房间列表。其主要职责变为：
    *   设置加载状态。
    *   将当前订单数据传递给账单创建对话框。
    *   弹出账单创建对话框。
*   **具体改动**:
    *   移除对 `orderStore.updateOrderStatusViaApi` 的调用。
    *   移除对 `roomStore.fetchAllRooms` 的调用。
    *   移除相关的成功通知。

#### `handleBillCreated` 函数调整
*   **职责增强**: 该函数将在账单创建成功后，负责完成后续的所有操作：
    1.  **获取原始订单数据**: 通过 `orderStore.getOrderByNumber(orderNumber, true)` 强制从后端获取订单的最新原始数据，以便与账单对话框中可能修改的房费和押金进行比较。
    2.  **比较并更新订单**: 
        *   比较账单对话框中确认的 `roomPrice` 和 `deposit` 与获取到的原始订单数据。
        *   如果发现 `roomPrice` 或 `deposit` 有差异，则构建一个更新对象，并调用 `orderStore.updateOrder(orderNumber, updatedFields)` 方法，将这些修改同步更新到 `orders` 数据库表中。
    3.  **更新订单状态**: 在确保房费和押金已同步（如果需要）后，调用 `orderStore.updateOrderStatusViaApi(orderNumber, 'checked-in')`，将订单状态正式更新为“已入住”。
    4.  **刷新房间状态**: 调用 `roomStore.fetchAllRooms()`，确保房间状态页面能够反映最新的占用情况。
    5.  **统一通知**: 在所有操作完成后，显示最终的成功通知。
    6.  关闭账单对话框，并处理加载状态。

### 3.3 Pinia Store 交互

*   **`orderStore.updateOrder(orderNumber, updatedFields)`**: 此方法将用于在账单确认后，如果房费或押金有修改，将其更新到订单表中。
*   **`orderStore.updateOrderStatusViaApi(orderNumber, newStatus)`**: 此方法将用于在账单确认且房费/押金同步后，最终更新订单状态。
*   **`orderStore.getOrderByNumber(orderNumber, true)`**: 此方法将用于在 `handleBillCreated` 中获取订单的原始数据进行比较。

## 4. Todo List (实现步骤)

1.  **修改 `src/pages/ViewOrders.vue` 中的 `performCheckIn` 函数**:
    *   删除 `await orderStore.updateOrderStatusViaApi(order.orderNumber, 'checked-in');`。
    *   删除 `await roomStore.fetchAllRooms();`。
    *   删除 `if (currentOrder.value && currentOrder.value.orderNumber === order.orderNumber) { ... }` 中关于 `currentOrder.value` 的状态更新。
    *   删除 `const isMultiDay = checkIfMultiDayOrder(updatedOrder);` 及后续的成功通知逻辑。
    *   保留 `loadingOrders.value = true;` 和 `loadingOrders.value = false;` 在 `try...finally` 块中。
    *   保留 `showBillDialog.value = true;` 和 `billOrder.value = { ...order };`。

2.  **修改 `src/pages/ViewOrders.vue` 中的 `handleBillCreated()` 函数**:
    *   在函数开始时，获取 `orderNumber = billOrder.value.orderNumber;`。
    *   **获取原始订单**: `const originalOrder = await orderStore.getOrderByNumber(orderNumber, true);`
    *   **比较房费和押金**:
        *   比较 `billOrder.value.roomPrice` (来自对话框) 与 `originalOrder.roomPrice`。
        *   比较 `billOrder.value.deposit` (来自对话框) 与 `originalOrder.deposit`。
    *   **条件更新订单**:
        *   如果 `billOrder.value.roomPrice` 与 `originalOrder.roomPrice` 不同，或者 `billOrder.value.deposit` 与 `originalOrder.deposit` 不同：
            *   构建一个 `updatedFields` 对象，包含 `roomPrice: billOrder.value.roomPrice` 和/或 `deposit: billOrder.value.deposit`。
            *   调用 `await orderStore.updateOrder(orderNumber, fieldsToUpdate);`。
    *   **更新订单状态**: 
        *   在上述比较和更新逻辑之后，调用 `await orderStore.updateOrderStatusViaApi(orderNumber, 'checked-in');`。
    *   **刷新房间状态**: `await roomStore.fetchAllRooms();`
    *   **统一成功通知**: 将原 `performCheckIn` 中的成功通知逻辑（包括多日账单的提示）移到此处。
    *   确保 `showBillDialog.value = false;`。
    *   确保 `loadingOrders.value` 在此函数结束时设置为 `false;`。

3.  **验证 `src/components/Bill.vue` 组件**:
    *   确保 `Bill.vue` 在用户确认账单时，能够将用户在对话框中对 `roomPrice` 和 `deposit` 的修改正确地反映到 `billOrder` 对象上（如果 `billOrder` 是通过 `v-model` 或响应式引用传递的，这通常会自动实现）。
