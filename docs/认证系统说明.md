# 酒店管理系统 - 登录注册功能文档

## 功能概述

本系统已实现完整的用户认证功能，包括用户注册、登录、邮箱验证、密码重置等功能。

## 主要功能

### 1. 用户注册 (`POST /api/auth/signup`)

**功能**: 新用户注册账户
**参数**:
- `name`: 用户姓名 (必填)
- `email`: 邮箱地址 (必填, 需符合邮箱格式)
- `pw`: 密码 (必填)

**返回**: 
- 成功: 200, 返回用户基本信息 (id, name, email)
- 失败: 400 (输入无效), 409 (邮箱已注册), 500 (服务器错误)

**安全特性**:
- 密码使用 bcrypt 加密存储 (saltRounds=10)
- 邮箱唯一性检查
- 输入数据格式验证

### 2. 用户登录 (`POST /api/auth/login`)

**功能**: 用户账户登录
**参数**:
- `email`: 邮箱地址 (必填)
- `pw`: 密码 (必填)

**返回**:
- 成功: 200, 返回用户信息并设置 session
- 失败: 450 (用户不存在), 451 (密码错误), 429 (频率限制), 400 (输入无效)

**安全特性**:
- IP 限流保护: 每日最多 100 次失败尝试
- 用户+IP 限流: 连续 6 次失败后锁定 30 分钟
- 密码加密验证
- Session 管理

### 3. 邮箱重复检查 (`GET /api/auth/check/email/:email`)

**功能**: 检查邮箱是否已被注册
**参数**: URL 参数中的邮箱地址
**返回**: 200, `{"exist": true/false}`

### 4. 邮箱验证功能

#### 发送验证邮件 (`POST /api/auth/send-email-verification`)
- 发送邮箱验证链接
- 验证码有效期: 10 分钟
- 频率限制: 同一邮箱 10 分钟内只能发送一次

#### 验证邮箱 (`POST /api/auth/email-verify`)
- 使用验证码验证邮箱
- 验证成功后更新数据库中的 `email_verified` 字段

### 5. 密码重置功能

#### 发送重置邮件 (`POST /api/auth/send-pwreset-email`)
- 发送密码重置链接
- 验证码有效期: 1 小时
- 频率限制: 同一邮箱 1 小时内只能发送一次

#### 重置密码 (`POST /api/auth/reset-pw`)
- 使用验证码重置密码
- 新密码使用 bcrypt 加密存储

#### 检查重置码 (`GET /api/auth/check/reset-code/:code`)
- 检查密码重置验证码是否有效

## 数据库结构

### account 表
```sql
CREATE TABLE account (
    id serial PRIMARY KEY,
    name text,
    email text UNIQUE,
    email_verified boolean,
    created_at timestamptz,
    pw text
);
```

## 前端集成

### Login.vue
- 支持邮箱登录
- 记住我功能
- 完整的错误处理
- 自定义状态码支持 (450, 451, 457, 429)

### Register.vue  
- 新用户注册
- 邮箱重复检查
- 密码确认验证
- 完整的错误处理

## 环境配置

需要的环境变量:
```
# 数据库
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=your_user
POSTGRES_PASSWORD=your_password
POSTGRES_DB=hotel_db

# Redis (用于限流和缓存)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PW=          # 可选，Redis 默认无密码时留空即可

# 邮箱设置
EMAIL_HOST=smtp.example.com
EMAIL_PORT=587
EMAIL_USER=your_email
EMAIL_PW=your_password
ADMIN_EMAIL=admin@example.com

# 应用设置
APP_NAME=hotelManagement
APP_URL=http://localhost:9000
NODE_ENV=dev
NODE_PORT=3000
```

## 安全措施

1. **密码安全**: bcrypt 加密存储
2. **频率限制**: Redis 实现的登录尝试限制
3. **会话管理**: Express-session 管理用户会话
4. **输入验证**: AJV 数据格式验证
5. **邮箱验证**: 防止虚假邮箱注册
6. **CORS 配置**: 开发环境跨域支持

## 测试

已包含完整的自动化测试 (`backend/tests/auth.test.js`):
- 注册功能测试
- 登录功能测试  
- 邮箱检查功能测试
- 错误处理测试

运行测试:
```bash
npm test -- backend/tests/auth.test.js
```

## 使用说明

1. 启动服务: `npm start`
2. 访问前端: http://localhost:9000
3. 后端 API: http://localhost:3000/api/auth/*

系统会自动初始化数据库表结构和 Redis 连接。首次使用时，请确保 PostgreSQL 和 Redis 服务正在运行。