# 新版交接班页面设计文档

## 1. 概述

本文档旨在设计一个全新的交接班页面 (`NewShiftHandover.vue`)，旨在提供一个更简洁、更可控的数据录入体验。新页面将保留现有页面的核心布局和样式，但对数据处理逻辑进行重构，以解决数据持久化问题并提供一个干净的初始状态。

## 2. 页面目标

- **简化初始状态**: 页面加载时，所有财务数据默认为0，为用户提供一个清晰的起点。
- **完全手动控制**: 用户可以手动填写所有财务字段，系统不会从订单自动统计数据进行覆盖。
- **可靠的数据持久化**: 实现一个稳健的保存机制，确保用户通过“保存金额修改”输入的数据在刷新页面或重启服务后依然存在。
- **保留核心功能**: 保留现有的“打印”、“导出Excel”、“保存交接记录”和“历史记录”功能。
- **风格一致性**: 在视觉上保持与现有交接班页面（`ShiftHandover.vue`）的高度一致性。

## 3. 页面设计

新页面将命名为 `NewShiftHandover.vue`，并放置在 `src/pages/` 目录下。

### 3.1. 视觉布局

新页面的布局将几乎完全复制 `ShiftHandover.vue` 的结构，包括：

- **标题区域**: "交接班"大标题和右侧的操作按钮组。
- **人员信息**: "交接日期"、"交班人"、"接班人"输入框。
- **主交接班表格**: 表格结构、表头（包括颜色和标签）、行（现金、微信等）将保持不变。
- **备忘录**: 保留现有的备忘录样式和交互功能。
- **特殊统计**: 保留“好评”、“大美卡”、“开房”等小型统计表格。

### 3.2. 核心功能逻辑

#### 数据初始化

- **财务数据**: `paymentData` 对象中的所有数值字段（如 `reserveCash`, `hotelIncome`, `restIncome` 等）在组件创建时将被初始化为 `0`。
- **固定默认值**:
    - `paymentData.cash.reserveCash` (现金备用金) 初始化为 `320`。
    - `paymentData.cash.retainedAmount` (现金留存款) 初始化为 `320`。
    这两个字段是业务规则固定的，因此保留其默认值。

#### 数据加载与恢复

- 页面加载时 (`onMounted`)，会调用一个新的API端点 `getLatestHandoverData`，该API专门用于获取指定日期**最新**的一条交接班记录（无论其状态）。
- 如果获取到当天已保存的数据，则用这些数据填充页面，覆盖初始的 `0` 值。
- **关键**: 此流程**不会**再从订单或任何其他来源自动计算统计数据。所有显示的数据要么是初始的 `0`（或固定默认值），要么是用户上次保存的数据。

#### 数据保存

- **保存金额修改**:
    - 点击此按钮时，页面会将当前的 `paymentData` 对象、人员信息、日期等数据打包。
    - 调用 `saveAmountChanges` API，将数据保存到数据库。该API会智能地更新当天的记录或创建新记录。
    - 保存成功后，用户刷新页面，`onMounted` 中的加载逻辑会确保恢复这些已存的数据。

- **保存交接记录**:
    - 此功能逻辑保持不变。它会保存一个更完整的记录，包括HTML快照和所有元数据。

#### 计算逻辑

- 表格中的“合计”和“交接款”列将继续使用前端实时计算，其计算逻辑与当前页面保持一致，确保用户输入后能立刻看到结果。
  - `合计 = 备用金 + 客房收入1 + 休息房收入2 + 租车收入3`
  - `交接款 = 合计 - 客房退押 - 休息退押 - 留存款`

## 4. API 需求

为了支持新页面的逻辑，需要对后端API进行少量调整或新增：

- **`GET /api/shift-handover/latest`** (建议新增):
  - **功能**: 根据日期查询最新的一条交接班记录。与现有的 `getPreviousHandoverData` 不同，这个接口不关心记录是“前一天”还是“当天”，只找最新的那条记录。这简化了前端恢复数据的逻辑。
  - **参数**: `date` (YYYY-MM-DD)
  - **返回**: 最新的交接班记录对象，或在没有记录时返回 `null`。

- **`POST /api/shift-handover/amount-changes`**:
  - **功能**: 逻辑保持不变。接收前端传来的部分数据并保存。后端需要有 "upsert"（更新或插入）逻辑来处理当天的记录。

## 5. 组件和文件结构

- **新文件**: `src/pages/NewShiftHandover.vue`
- **路由更新**: 在 `src/router/routes.js` 中添加新路由:
  ```javascript
  {
    path: '/new-shift-handover',
    component: () => import('pages/NewShiftHandover.vue')
  }
  ```
- **API文件**: 在 `src/api/shiftHandover.js` 中添加对新API端点的调用。

## 6. 预期效果

用户打开新版交接班页面时，会看到一个干净、数据为零的表格（除了固定的现金备用金/留存款）。他们可以自由填写，并通过“保存金额修改”按钮随时保存自己的进度。无论何时刷新页面，他们填写的数据都会被完好地加载回来，直到他们最终点击“保存交接记录”来完成整个流程。 