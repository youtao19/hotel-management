# 交接班金额计算测试案例使用指南

## 概述

这个测试文件包含7个真实业务场景的交接班金额计算测试案例，帮助您验证酒店管理系统中交接班金额计算的正确性。

## 运行测试

```bash
# 运行所有交接班金额计算测试
npm test -- --testPathPattern=handoverAmountCalculation.test.js

# 静默模式运行（减少输出）
npm test -- --testPathPattern=handoverAmountCalculation.test.js --silent
```

## 测试案例详解

### 案例1：简单单笔交易
**场景描述**：一天只有一笔客房订单，现金支付
- **测试数据**：
  - 前日交接款：现金500，微信800，微邮付200，其他100
  - 当日订单：现金支付400元（房费300+押金100）
- **预期结果**：
  - 备用金：现金500
  - 客房收入：现金400
  - 总收入：现金900（400+500）
  - 交接款：现金580（900-320留存款）

### 案例2：多种支付方式混合
**场景描述**：同一天有多笔订单，使用不同支付方式
- **测试数据**：
  - 前日交接款：现金200，微信300，微邮付100，其他50
  - 当日订单：3笔订单分别用现金、微信、微邮付支付
- **验证要点**：
  - 客房收入和休息房收入分别统计
  - 不同支付方式的金额正确累加
  - 总收入 = 各项收入 + 对应支付方式的备用金

### 案例3：包含退押金的复杂场景
**场景描述**：有收入也有退押金，测试退押金对交接款的影响
- **测试数据**：
  - 前日交接款：现金1000，微信500
  - 当日收入：现金800，微信400
  - 退押金：现金150，微信80
- **验证要点**：
  - 交接款 = 总收入 - 退押金 - 留存款
  - 退押金正确从对应支付方式中扣除

### 案例4：无前日数据的新开始场景
**场景描述**：第一天开始使用系统，没有前一天的交接款数据
- **测试数据**：
  - 无前日交接款数据
  - 当日订单：现金300元
- **验证要点**：
  - 备用金全部为0
  - 总收入等于当日收入
  - 可能出现负的交接款（当日收入少于留存款时）

### 案例5：大额交易和边界情况
**包含两个子测试：**

#### 5.1 大额交易
- **测试数据**：大额前日交接款和当日25000元订单
- **验证要点**：系统能正确处理大额数字计算

#### 5.2 零值和负值情况
- **测试数据**：很小的前日交接款，大额退押金
- **验证要点**：系统能正确处理负数交接款

### 案例6：实际业务场景模拟
**场景描述**：模拟一个典型酒店一天的真实交易（情人节，生意较好）
- **测试数据**：
  - 8笔订单，包含客房和休息房
  - 多种支付方式混合
  - 包含部分退押金
- **验证要点**：
  - 复杂场景下的综合计算正确性
  - 多种业务类型的正确分类和统计

## 金额计算公式验证

所有测试案例都基于以下核心公式：

1. **备用金** = 前一日各支付方式的交接款
2. **总收入** = 客房收入 + 休息房收入 + 租车收入 + 备用金
3. **交接款** = 总收入 - 客房退押 - 休息房退押 - 留存款
4. **现金留存款**固定为320元

## 使用这些测试案例的好处

### 1. 验证计算逻辑
- 确保金额计算公式正确实现
- 验证各种边界情况的处理
- 检查数据类型和精度处理

### 2. 回归测试
- 代码修改后快速验证功能完整性
- 防止新功能破坏现有计算逻辑
- 确保业务规则一致性

### 3. 文档和示例
- 为新开发人员提供业务逻辑参考
- 展示系统期望的数据格式和计算结果
- 作为业务需求的可执行文档

### 4. 问题排查
- 当发现计算错误时，快速定位问题
- 通过对比期望值和实际值找出差异
- 验证修复后的正确性

## 扩展测试案例

您可以基于现有案例创建更多测试：

```javascript
// 添加新的测试案例示例
it('应该正确处理特殊业务场景', async () => {
  const testDate = '2024-03-01';
  const prevDate = '2024-02-29';
  
  // 1. 设置前日交接款
  await query(`...`);
  
  // 2. 创建测试数据
  const roomType = await createTestRoomType();
  const room = await createTestRoom(roomType.type_code, { room_number: '301' });
  
  // 3. 创建订单
  const order = await createTestOrder({...}, { insert: true });
  
  // 4. 创建账单
  await query(`...`);
  
  // 5. 验证结果
  const res = await request(app).get(`/api/handover/table?date=${testDate}`);
  expect(res.body.data.handoverAmount['现金']).toBe(expectedAmount);
});
```

## 注意事项

1. **数据隔离**：每个测试用例都会清理数据，确保测试独立性
2. **真实API调用**：测试使用真实的API端点，不是mock数据
3. **完整流程**：从数据准备到结果验证的完整业务流程
4. **精确验证**：所有金额都进行精确的数值比较

通过这些测试案例，您可以确信您的交接班金额计算是准确和可靠的！